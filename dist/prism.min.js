function Board(e){var t="undefined"!=typeof window?window.Events:{emit:function(){}};this.score=0,this.isGameOver=!1,this.resetGrid=function(){this.grid=_.map(Array(4),function(){return _.map(Array(4),function(){return 0})})},e?this.grid=e:this.resetGrid(),this.newGame=function(){this.resetGrid(),this.spawn(),this.spawn(),this.score=0,this.isGameOver=!1},this.hasAnotherMove=function(){for(var e=0;e<this.grid.length;e++)for(var t=0;t<this.grid[0].length;t++){if(!this.grid[e][t])return!0;var r=[[-1,0],[1,0],[0,-1],[0,1]],o=this;if(_.some(r,function(r){return o.grid[e+r[0]]&&o.grid[e][t]===o.grid[e+r[0]][t+r[1]]}))return!0}return!1},this.spawn=function(){for(var e=[],r=0;r<this.grid.length;r++)for(var o=0;o<this.grid[0].length;o++)this.grid[r][o]||e.push([r,o]);if(!this.hasAnotherMove())return this.endGame();if(e.length){var n=_.sample(e),i=n[0],s=n[1],a=Math.random()<.1?2:1;return this.grid[i][s]=a,t.emit("spawn",{row:i,col:s,color:a}),[i,s]}},this.endGame=function(){this.isGameOver=!0,t.emit("gameOver")},this.move=function(e){this.isGameOver||(GAME.tutorial&&GAME.tutorial.nextStep(),this._move(e),this.spawn())},this._move=function(e){var r={up:[-1,0],down:[1,0],left:[0,-1],right:[0,1]},o=this.grid,n=r[e],i=_.range(0,4),s=_.range(0,4);"down"===e&&i.reverse(),"right"===e&&s.reverse();for(var a=0;a<i.length;a++)for(var l=0;l<s.length;l++){var d=i[a],c=s[l],m=d,u=c;if(o[d]&&o[d][c]){for(var p=o[d][c];o[d+n[0]]&&(0===o[d+n[0]][c+n[1]]||o[d][c]===o[d+n[0]][c+n[1]]);)p=o[d][c],o[d][c]===o[d+n[0]][c+n[1]]&&(p=o[d][c]+1+Math.random()/2,this.score+=Math.pow(2*o[d][c],2)),o[d][c]=0,d+=n[0],c+=n[1],o[d][c]=p;t.emit("score",this.score),t.emit("move",{fromRow:m,toRow:d,fromCol:u,toCol:c}),t.emit("setColor",{row:d,col:c,color:Math.floor(p)})}}this.grid=_.map(o,function(e){return _.map(e,Math.floor.bind(Math))})}}function sizing(){var e=$grid.offsetWidth,t=$grid.offsetHeight,r=Math.min(e,t);$(".grid-background")[0].style.width=r+"px",$(".grid-background")[0].style.height=r-14+"px"}function Tutorial(e){var t="undefined"!=typeof window?window.Events:{emit:function(){}};this.steps=[{message:"Swipe any direction to move tiles",x:25*e[1]+"%",y:25*e[0]+"%",position:"absolute"},{message:"Combine same-color tiles to make a new color",x:25*e[1]+"%",y:25*e[0]+"%",position:"absolute"},{message:"Your progress is shown on this bar",x:"50%",y:"5px",position:"fixed"},{message:"You win by making the full rainbow",x:"50%",y:"5px",position:"fixed"}],this.currentStep=-1,this.removeCurrentTip=function(){var e=document.getElementById("tip");e&&e.parentNode.removeChild(e)},this.nextStep=function(e,r){if(this.currentStep++,!this.steps[this.currentStep])return void this.closeTutorial();this.removeCurrentTip();var o=document.createElement("div");o.id="tip";var e=this.steps[this.currentStep].x,r=this.steps[this.currentStep].y,n=-1!==r.indexOf("%")&&parseInt(r)>=50?"bottom":"top";"bottom"==n?o.style.bottom=100-parseInt(r)+"%":o.style.top=-1!==r.indexOf("%")?25+parseInt(r)+"%":r;var i=e.indexOf("%")!==!1&&parseInt(e)>=50?"right":"left";"right"==i?o.style.right=75-parseInt(e)+"%":o.style.left=e.indexOf("%")!==!1?parseInt(e)+"%":e,o.style.position=this.steps[this.currentStep].position;var s=document.createElement("div");s.innerHTML=this.steps[this.currentStep].message;var a=document.createElement("a");a.innerText="Next Step";var l=this;a.addEventListener("click",function(){l.nextStep()});var d=document.createElement("div"),c=document.createElement("div");"bottom"==n?(d.className="arrow-bottom",c.className="arrow-bottom-border"):(d.className="arrow-top",c.className="arrow-top-border"),o.appendChild(s),o.appendChild(a),o.appendChild(c),o.appendChild(d),$(".grid-background")[0].appendChild(o),t.emit("nextStep",{})},this.closeTutorial=function(){this.removeCurrentTip()},this.nextStep()}"undefined"!=typeof module&&(module.exports=Board),function(){var e,t,r={},o=0;this.Events={on:function(e,t,o){r[e]=r[e]||[],r[e].push({f:t,c:o})},off:function(t,n){if(e=r[t]||[],!n)return e.length=0;for(o=e.length;0<=--o;)n==e[o].f&&e.splice(o,1)},emit:function(){for(t=Array.apply([],arguments),e=r[t.shift()]||[],t=t[0]instanceof Array&&t[0]||t,o=e.length;0<=--o;)e[o].f.apply(e[o].c,t)}}}();var $=document.querySelectorAll.bind(document),GAME={board:new Board},$grid=$(".grid")[0];Events.on("move",function(e){if(e.fromRow!==e.toRow||e.fromCol!==e.toCol){var t=$(".tile-"+e.fromRow+"-"+e.fromCol),r=$(".tile-"+e.toRow+"-"+e.toCol)[0];_.map(t,function(t){t.className=t.className.replace(/tile-\d-\d/,"tile-"+e.toRow+"-"+e.toCol)}),r&&setTimeout(function(){_.map(t,function(e){try{e.parentElement.removeChild(e)}catch(t){}})},1e3)}}),Events.on("spawn",function(e){var t=document.createElement("div"),r=document.createElement("div");r.setAttribute("class","tile tile-"+e.row+"-"+e.col+" tile-phase-"+(e.color-1)),r.appendChild(t),$grid.appendChild(r)});var maxColor=1;Events.on("setColor",function(e){var t=$(".tile-"+e.row+"-"+e.col);try{_.map(t,function(t){t.className=t.className.replace(/tile-phase-\d/,"tile-phase-"+(e.color-1))}),e.color>maxColor&&(maxColor=e.color,$progress=$("#progress-cover")[0],$progress.className=$progress.className.replace(/progress-\d/,"progress-"+(maxColor-1)))}catch(r){}});var gameOverOnce=!1;Events.on("gameOver",function(){maxColor=0;var e=document.getElementById("info-screen");e.className="show";var t=document.getElementById("game-over-box");t.style.display="block";var r=document.createElement("button");if(r.innerText="Challenge a Friend",r.addEventListener("click",function(){Events.emit("challengeFriend")}),!gameOverOnce){var o=document.createElement("button");o.innerText="Play Again",o.className="play-again",o.addEventListener("click",function(){Events.emit("restartGame")}),t.appendChild(r),t.appendChild(o),gameOverOnce=!0}}),Events.on("challengeFriend",function(){var e=GAME.board.score;Clay.Social.smartShare({message:"Think you can beat my score?",title:"I just scored "+e+" in Prism!",data:{}})}),Events.on("restartGame",function(){$(".grid")[0].innerHTML="",document.getElementById("progress-cover").className="progress-0",document.getElementById("info-screen").className="hide",GAME.board.newGame()}),Events.on("score",function(e){$("#score")[0].innerHTML=e});var move="left";Hammer(window).on("dragleft",function(e){e.preventDefault(),e.gesture.preventDefault(),move="left"}).on("dragright",function(e){e.preventDefault(),e.gesture.preventDefault(),move="right"}).on("dragup",function(e){e.preventDefault(),e.gesture.preventDefault(),move="up"}).on("dragdown",function(e){e.preventDefault(),e.gesture.preventDefault(),move="down"}).on("dragend",function(){GAME.board.move(move)}),Mousetrap.bind(["up","down","left","right"],function(e){GAME.board.move(e.keyIdentifier.toLowerCase())}),GAME.board.spawn();var spawnPos=GAME.board.spawn();localStorage["tutorial-shown"]||(GAME.tutorial=new Tutorial(spawnPos),localStorage["tutorial-shown"]=1),sizing(),$grid.style.visibility="visible",$(".grid-background")[0].style.visibility="visible",window.onresize=sizing,"undefined"!=typeof module&&(module.exports=Tutorial);